<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Demo</title>
    <script src="https://unpkg.com/@metamask/detect-provider/dist/detect-provider.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.2.11/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
</head>
<body>
<div id="app">
    <li> 当前账户: {{ accountAddress }} </li>
    <li> 钱包余额: {{ accountBalance }} </li>
</div>
</body>
<script type="text/javascript">
    var app = new Vue({
        el: '#app',
        data: {
            accountAddress: '',
            accountBalance: ''
        }
    })
    var iRiskManager = "[ { \"inputs\": [], \"name\": \"isRiskManager\", \"outputs\": [ { \"internalType\": \"bool\", \"name\": \"\", \"type\": \"bool\" } ], \"stateMutability\": \"view\", \"type\": \"function\" }, { \"inputs\": [ { \"internalType\": \"address[]\", \"name\": \"pTokens\", \"type\": \"address[]\" } ], \"name\": \"enterMarkets\", \"outputs\": [ { \"internalType\": \"uint256[]\", \"name\": \"\", \"type\": \"uint256[]\" } ], \"stateMutability\": \"nonpayable\", \"type\": \"function\" }, { \"inputs\": [ { \"internalType\": \"address\", \"name\": \"pToken\", \"type\": \"address\" } ], \"name\": \"exitMarket\", \"outputs\": [ { \"internalType\": \"uint256\", \"name\": \"\", \"type\": \"uint256\" } ], \"stateMutability\": \"nonpayable\", \"type\": \"function\" }, { \"inputs\": [ { \"internalType\": \"address\", \"name\": \"pToken\", \"type\": \"address\" }, { \"internalType\": \"address\", \"name\": \"minter\", \"type\": \"address\" }, { \"internalType\": \"uint256\", \"name\": \"mintAmount\", \"type\": \"uint256\" } ], \"name\": \"mintAllowed\", \"outputs\": [ { \"internalType\": \"uint256\", \"name\": \"\", \"type\": \"uint256\" } ], \"stateMutability\": \"nonpayable\", \"type\": \"function\" }, { \"inputs\": [ { \"internalType\": \"address\", \"name\": \"pToken\", \"type\": \"address\" }, { \"internalType\": \"address\", \"name\": \"redeemer\", \"type\": \"address\" }, { \"internalType\": \"uint256\", \"name\": \"redeemTokens\", \"type\": \"uint256\" } ], \"name\": \"redeemAllowed\", \"outputs\": [ { \"internalType\": \"uint256\", \"name\": \"\", \"type\": \"uint256\" } ], \"stateMutability\": \"nonpayable\", \"type\": \"function\" }, { \"inputs\": [ { \"internalType\": \"address\", \"name\": \"pToken\", \"type\": \"address\" }, { \"internalType\": \"address\", \"name\": \"borrower\", \"type\": \"address\" }, { \"internalType\": \"uint256\", \"name\": \"borrowAmount\", \"type\": \"uint256\" } ], \"name\": \"borrowAllowed\", \"outputs\": [ { \"internalType\": \"uint256\", \"name\": \"\", \"type\": \"uint256\" } ], \"stateMutability\": \"nonpayable\", \"type\": \"function\" }, { \"inputs\": [ { \"internalType\": \"address\", \"name\": \"pToken\", \"type\": \"address\" }, { \"internalType\": \"address\", \"name\": \"payer\", \"type\": \"address\" }, { \"internalType\": \"address\", \"name\": \"borrower\", \"type\": \"address\" }, { \"internalType\": \"uint256\", \"name\": \"repayAmount\", \"type\": \"uint256\" } ], \"name\": \"repayBorrowAllowed\", \"outputs\": [ { \"internalType\": \"uint256\", \"name\": \"\", \"type\": \"uint256\" } ], \"stateMutability\": \"nonpayable\", \"type\": \"function\" }, { \"inputs\": [ { \"internalType\": \"address\", \"name\": \"pTokenBorrowed\", \"type\": \"address\" }, { \"internalType\": \"address\", \"name\": \"pTokenCollateral\", \"type\": \"address\" }, { \"internalType\": \"address\", \"name\": \"liquidator\", \"type\": \"address\" }, { \"internalType\": \"address\", \"name\": \"borrower\", \"type\": \"address\" }, { \"internalType\": \"uint256\", \"name\": \"repayAmount\", \"type\": \"uint256\" } ], \"name\": \"liquidateBorrowAllowed\", \"outputs\": [ { \"internalType\": \"uint256\", \"name\": \"\", \"type\": \"uint256\" } ], \"stateMutability\": \"nonpayable\", \"type\": \"function\" }, { \"inputs\": [ { \"internalType\": \"address\", \"name\": \"pTokenCollateral\", \"type\": \"address\" }, { \"internalType\": \"address\", \"name\": \"pTokenBorrowed\", \"type\": \"address\" }, { \"internalType\": \"address\", \"name\": \"liquidator\", \"type\": \"address\" }, { \"internalType\": \"address\", \"name\": \"borrower\", \"type\": \"address\" }, { \"internalType\": \"uint256\", \"name\": \"seizeTokens\", \"type\": \"uint256\" } ], \"name\": \"seizeAllowed\", \"outputs\": [ { \"internalType\": \"uint256\", \"name\": \"\", \"type\": \"uint256\" } ], \"stateMutability\": \"nonpayable\", \"type\": \"function\" }, { \"inputs\": [ { \"internalType\": \"address\", \"name\": \"pToken\", \"type\": \"address\" }, { \"internalType\": \"address\", \"name\": \"src\", \"type\": \"address\" }, { \"internalType\": \"address\", \"name\": \"dst\", \"type\": \"address\" }, { \"internalType\": \"uint256\", \"name\": \"transferTokens\", \"type\": \"uint256\" } ], \"name\": \"transferAllowed\", \"outputs\": [ { \"internalType\": \"uint256\", \"name\": \"\", \"type\": \"uint256\" } ], \"stateMutability\": \"nonpayable\", \"type\": \"function\" }, { \"inputs\": [ { \"internalType\": \"address\", \"name\": \"pTokenBorrowed\", \"type\": \"address\" }, { \"internalType\": \"address\", \"name\": \"pTokenCollateral\", \"type\": \"address\" }, { \"internalType\": \"uint256\", \"name\": \"repayAmount\", \"type\": \"uint256\" } ], \"name\": \"liquidateCalculateSeizeTokens\", \"outputs\": [ { \"internalType\": \"uint256\", \"name\": \"\", \"type\": \"uint256\" }, { \"internalType\": \"uint256\", \"name\": \"\", \"type\": \"uint256\" } ], \"stateMutability\": \"view\", \"type\": \"function\" }, { \"inputs\": [ { \"internalType\": \"address\", \"name\": \"pToken\", \"type\": \"address\" } ], \"name\": \"updateAndGetTokenPrice\", \"outputs\": [ { \"internalType\": \"uint256\", \"name\": \"\", \"type\": \"uint256\" } ], \"stateMutability\": \"payable\", \"type\": \"function\" }, { \"inputs\": [ { \"internalType\": \"address\", \"name\": \"pToken\", \"type\": \"address\" } ], \"name\": \"getPriceCost\", \"outputs\": [ { \"internalType\": \"uint256\", \"name\": \"\", \"type\": \"uint256\" } ], \"stateMutability\": \"view\", \"type\": \"function\" }, { \"inputs\": [], \"name\": \"getAllMarkets\", \"outputs\": [ { \"internalType\": \"address[]\", \"name\": \"\", \"type\": \"address[]\" } ], \"stateMutability\": \"view\", \"type\": \"function\" } ]";

    const provider = detectEthereumProvider()

    if (provider) {
        ethereum.autoRefreshOnNetworkChange = false
        let chainId = ethereum.chainId
        console.log("ethereum.chainId: " + chainId)
        console.log('Ethereum successfully detected!')

        window.web3 = new Web3(window.ethereum)
        window.ethereum.enable();

        getAccount().then(function(defaultAccount) {
            console.log(defaultAccount)
            app.accountAddress = defaultAccount;
            // 获取账户余额
            web3.eth.getBalance(defaultAccount, function(err, result) {
                if (err) {
                    console.log(err)
                } else {
                    app.accountBalance = web3.utils.fromWei(result, "ether") + " ETH"
                }
            })

            var contract = new web3.eth.Contract(JSON.parse(iRiskManager), "0x36E31a406D955F82960fE2ec21DF254c7f61aBdd");
            contract.methods.getAllMarkets().call(function (err, result) {
                console.log(result)
            })
            // contract.methods.updateAndGetTokenPrice("0xa93fc2Ac9364B225DedE4e8374251C7Fd7a15E3B").send({from: defaultAccount, value: web3.utils.toWei("0.001")}).on("error", function (error, receipt) {
            //     console.error(error)
            // })
        })
    } else {
        console.error('Please install MetaMask!')
    }

    async function getAccount() {
        const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
        const account = accounts[0];
        return account
    }
</script>
</html>